name: Build Windows

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装 Qt
      uses: jurplel/install-qt-action@v4
      id: qt
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine'
        cache: true
        
    - name: 安装 CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27'
        
    - name: 配置构建目录
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path build
        
    - name: 配置 CMake
      shell: powershell
      working-directory: build
      env:
        QT_DIR: ${{ steps.qt.outputs.qt-dir }}
      run: |
        cmake .. `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:QT_DIR" `
          -DENABLE_QTWEBENGINE=ON `
          -DENABLE_QTWEBKIT=OFF `
          -DENABLE_SPELLCHECK=OFF
          
    - name: 编译项目
      shell: powershell
      working-directory: build
      run: |
        cmake --build . --config Release --parallel
        
    - name: 创建发布目录
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item -Path "build\Release\otter-browser.exe" -Destination "release\" -Force
        
    - name: 查找 Qt 安装路径
      shell: powershell
      id: find-qt
      run: |
        # 尝试从 action 输出获取
        $qtDir = "${{ steps.qt.outputs.qt-dir }}"
        Write-Host "Qt dir from action: $qtDir"
        
        # 如果输出为空，尝试从环境变量获取
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          $qtDir = $env:QT_DIR
          Write-Host "Qt dir from env: $qtDir"
        }
        
        # 如果还是为空，尝试查找 windeployqt
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Searching for Qt installation..."
          # 检查常见路径
          $possiblePaths = @(
            "$env:ProgramFiles\Qt\5.15.2\msvc2019_64",
            "$env:ProgramFiles(x86)\Qt\5.15.2\msvc2019_64",
            "C:\Qt\5.15.2\msvc2019_64",
            "D:\a\otter-browser\Qt\5.15.2\msvc2019_64"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path "$path\bin\windeployqt.exe") {
              $qtDir = $path
              Write-Host "Found Qt at: $qtDir"
              break
            }
          }
        }
        
        # 最后尝试在 PATH 中查找
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          $windeployqt = Get-Command windeployqt.exe -ErrorAction SilentlyContinue
          if ($windeployqt) {
            $qtDir = Split-Path (Split-Path $windeployqt.Source)
            Write-Host "Found Qt via PATH: $qtDir"
          }
        }
        
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Error: Could not find Qt installation"
          Write-Host "Checking D:\a directory..."
          Get-ChildItem -Path "D:\a" -Recurse -Filter "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 3 | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }
          exit 1
        }
        
        Write-Host "Using Qt directory: $qtDir"
        echo "qt-dir=$qtDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: 使用 windeployqt 部署 Qt 依赖
      shell: powershell
      run: |
        $qtDir = "${{ steps.find-qt.outputs.qt-dir }}"
        $windeployqt = "$qtDir\bin\windeployqt.exe"
        Write-Host "Qt directory: $qtDir"
        Write-Host "windeployqt path: $windeployqt"
        
        if (Test-Path $windeployqt) {
          Write-Host "Deploying Qt dependencies..."
          
          # 部署基本 Qt 依赖（包含翻译文件，因为 QtWebEngine 可能需要）
          & $windeployqt `
            --release `
            --qmldir "$PWD" `
            --no-opengl-sw `
            --no-system-d3d-compiler `
            --no-compiler-runtime `
            "release\otter-browser.exe"
          
          Write-Host "Checking for QtWebEngine dependencies..."
          
          # 查找并复制 QtWebEngine 的资源文件
          # QtWebEngine 资源文件可能在多个位置
          $possibleResourcePaths = @(
            "$qtDir\resources",
            "$qtDir\..\resources"
          )
          
          foreach ($resourcePath in $possibleResourcePaths) {
            if (Test-Path $resourcePath) {
              Write-Host "Found resources at: $resourcePath"
              New-Item -ItemType Directory -Force -Path "release\resources" -ErrorAction SilentlyContinue
              Copy-Item -Path "$resourcePath\*" -Destination "release\resources\" -Recurse -Force
              break
            }
          }
          
          # 复制 QtWebEngine 进程可执行文件
          $qtWebEngineProcess = "$qtDir\bin\QtWebEngineProcess.exe"
          if (Test-Path $qtWebEngineProcess) {
            Write-Host "Copying QtWebEngineProcess.exe"
            Copy-Item -Path $qtWebEngineProcess -Destination "release\" -Force
          } else {
            Write-Host "Warning: QtWebEngineProcess.exe not found at $qtWebEngineProcess"
          }
          
          # 确保所有 QtWebEngine DLL 文件都被复制
          $qtBinDir = "$qtDir\bin"
          $webEngineDlls = Get-ChildItem -Path $qtBinDir -Filter "Qt5WebEngine*.dll" -ErrorAction SilentlyContinue
          if ($webEngineDlls) {
            Write-Host "Copying QtWebEngine DLL files:"
            foreach ($dll in $webEngineDlls) {
              Write-Host "  - $($dll.Name)"
              Copy-Item -Path $dll.FullName -Destination "release\" -Force
            }
          } else {
            Write-Host "Warning: No QtWebEngine DLL files found in $qtBinDir"
          }
          
          # 列出部署后的文件以验证
          Write-Host "`nDeployed files in release directory:"
          Get-ChildItem -Path "release" -File | Select-Object Name | ForEach-Object { Write-Host "  - $($_.Name)" }
          Write-Host "`nDeployed directories:"
          Get-ChildItem -Path "release" -Directory | Select-Object Name | ForEach-Object { Write-Host "  - $($_.Name)\" }
        } else {
          Write-Host "Error: windeployqt not found at $windeployqt"
          exit 1
        }
        
    - name: 复制翻译文件
      shell: powershell
      run: |
        if (Test-Path "resources\translations") {
          New-Item -ItemType Directory -Force -Path "release\locale" -ErrorAction SilentlyContinue
          Copy-Item -Path "resources\translations\*.qm" -Destination "release\locale\" -Force
        }
        
    - name: 读取版本号
      shell: powershell
      id: version
      run: |
        $content = Get-Content "CMakeLists.txt" -Raw
        if ($content -match 'set\(MAJOR_VERSION "(\d+)"\)') {
          $major = $matches[1]
        }
        if ($content -match 'set\(MINOR_VERSION "(\d+)"\)') {
          $minor = $matches[1]
        }
        if ($content -match 'set\(PATCH_VERSION "(\d+)"\)') {
          $patch = $matches[1]
        }
        $version = "$major.$minor.$patch"
        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "Version: $version"
        
    - name: 创建 ZIP 压缩包
      shell: powershell
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        $zipName = "otter-browser-win64-$env:VERSION.zip"
        Compress-Archive -Path "release\*" -DestinationPath $zipName -Force
        echo "Created: $zipName"
        
    - name: 上传 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: otter-browser-windows-${{ steps.version.outputs.version }}
        path: |
          otter-browser-win64-*.zip
        retention-days: 30

