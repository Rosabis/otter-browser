name: Build Windows

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装 Qt
      uses: jurplel/install-qt-action@v4
      id: qt
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        cache: true
        
    - name: 安装 CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27'
        
    - name: 安装 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 安装 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 安装 Perl
      shell: powershell
      run: |
        Write-Host "Installing Strawberry Perl..."
        choco install strawberryperl -y
        # 刷新 PATH
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        Write-Host "Perl version:"
        perl --version
        
    - name: 查找 Qt 安装路径
      shell: powershell
      id: find-qt-for-webkit
      run: |
        # 尝试从 action 输出获取
        $qtDir = "${{ steps.qt.outputs.qt-dir }}"
        Write-Host "Qt dir from action: $qtDir"
        
        # 如果输出为空，尝试从环境变量获取
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          $qtDir = $env:QT_DIR
          Write-Host "Qt dir from env: $qtDir"
        }
        
        # 如果还是为空，尝试查找常见路径
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Searching for Qt installation..."
          $possiblePaths = @(
            "$env:ProgramFiles\Qt\5.15.2\msvc2019_64",
            "$env:ProgramFiles(x86)\Qt\5.15.2\msvc2019_64",
            "C:\Qt\5.15.2\msvc2019_64",
            "D:\a\otter-browser\Qt\5.15.2\msvc2019_64"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path "$path\bin\qmake.exe") {
              $qtDir = $path
              Write-Host "Found Qt at: $qtDir"
              break
            }
          }
        }
        
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Error: Could not find Qt installation"
          exit 1
        }
        
        Write-Host "Using Qt directory: $qtDir"
        echo "qt-dir=$qtDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: 编译 QtWebKit
      shell: powershell
      run: |
        $qtDir = "${{ steps.find-qt-for-webkit.outputs.qt-dir }}"
        Write-Host "Qt directory: $qtDir"
        
        # 检查是否已安装 QtWebKit
        $qtWebKitDll = "$qtDir\bin\Qt5WebKit.dll"
        if (Test-Path $qtWebKitDll) {
          Write-Host "QtWebKit already installed, skipping compilation"
          exit 0
        }
        
        # 克隆 QtWebKit 源代码
        # 使用官方 qtwebkit 仓库，它使用不同的分支结构
        Write-Host "Cloning QtWebKit source code..."
        if (-not (Test-Path "qtwebkit")) {
          # 尝试使用官方 qtwebkit 仓库 (code.qt.io)
          Write-Host "Trying official qtwebkit repository..."
          git clone --depth 1 https://code.qt.io/cgit/qt/qtwebkit.git qtwebkit
          if ($LASTEXITCODE -eq 0) {
            Push-Location qtwebkit
            # 尝试切换到 5.212 分支
            Write-Host "Checking for 5.212 branch..."
            git fetch --depth 1 origin 5.212 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0) {
              git checkout 5.212 2>&1 | Out-Null
              Write-Host "Checked out 5.212 branch"
            } else {
              Write-Host "5.212 branch not found, checking available branches..."
              git branch -r | Select-Object -First 10
              Write-Host "Using default branch"
            }
            Pop-Location
          } else {
            # 如果官方仓库失败，尝试 movableink/webkit (master 分支)
            Write-Host "Official repository failed, trying movableink/webkit..."
            Remove-Item -Path qtwebkit -Recurse -Force -ErrorAction SilentlyContinue
            git clone --depth 1 https://github.com/movableink/webkit.git qtwebkit
            Write-Host "Using master branch from movableink/webkit"
          }
        } else {
          Write-Host "QtWebKit directory already exists"
        }
        
        # 创建构建目录
        New-Item -ItemType Directory -Force -Path qtwebkit-build | Out-Null
        
        # 配置 QtWebKit
        Write-Host "Configuring QtWebKit..."
        Push-Location qtwebkit-build
        
        # 使用 Visual Studio 2022 生成器
        cmake ..\qtwebkit `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$qtDir" `
          -DPORT=Qt `
          -DCMAKE_INSTALL_PREFIX="$qtDir" `
          -DENABLE_TOOLS=OFF `
          -DENABLE_API_TESTS=OFF
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "CMake configuration failed"
          Pop-Location
          exit 1
        }
        
        # 编译 QtWebKit (这可能需要很长时间，使用所有可用核心)
        Write-Host "Building QtWebKit (this may take 1-3 hours)..."
        $cpuCount = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
        Write-Host "Using $cpuCount parallel jobs"
        cmake --build . --config Release --parallel $cpuCount
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "QtWebKit build failed"
          Pop-Location
          exit 1
        }
        
        # 安装 QtWebKit 到 Qt 目录
        Write-Host "Installing QtWebKit..."
        cmake --install . --config Release
        
        Pop-Location
        Write-Host "QtWebKit compilation completed successfully"
        
        # 验证安装
        if (Test-Path $qtWebKitDll) {
          Write-Host "QtWebKit installation verified: $qtWebKitDll"
        } else {
          Write-Host "Warning: QtWebKit DLL not found after installation at $qtWebKitDll"
        }
        
    - name: 配置构建目录
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path build
        
    - name: 配置 CMake
      shell: powershell
      working-directory: build
      env:
        QT_DIR: ${{ steps.qt.outputs.qt-dir }}
      run: |
        cmake .. `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:QT_DIR" `
          -DENABLE_QTWEBENGINE=OFF `
          -DENABLE_QTWEBKIT=ON `
          -DENABLE_SPELLCHECK=OFF
          
    - name: 编译项目
      shell: powershell
      working-directory: build
      run: |
        cmake --build . --config Release --parallel
        
    - name: 创建发布目录
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item -Path "build\Release\otter-browser.exe" -Destination "release\" -Force
        
    - name: 查找 Qt 安装路径
      shell: powershell
      id: find-qt
      run: |
        # 尝试从 action 输出获取
        $qtDir = "${{ steps.qt.outputs.qt-dir }}"
        Write-Host "Qt dir from action: $qtDir"
        
        # 如果输出为空，尝试从环境变量获取
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          $qtDir = $env:QT_DIR
          Write-Host "Qt dir from env: $qtDir"
        }
        
        # 如果还是为空，尝试查找 windeployqt
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Searching for Qt installation..."
          # 检查常见路径
          $possiblePaths = @(
            "$env:ProgramFiles\Qt\5.15.2\msvc2019_64",
            "$env:ProgramFiles(x86)\Qt\5.15.2\msvc2019_64",
            "C:\Qt\5.15.2\msvc2019_64",
            "D:\a\otter-browser\Qt\5.15.2\msvc2019_64"
          )
          foreach ($path in $possiblePaths) {
            if (Test-Path "$path\bin\windeployqt.exe") {
              $qtDir = $path
              Write-Host "Found Qt at: $qtDir"
              break
            }
          }
        }
        
        # 最后尝试在 PATH 中查找
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          $windeployqt = Get-Command windeployqt.exe -ErrorAction SilentlyContinue
          if ($windeployqt) {
            $qtDir = Split-Path (Split-Path $windeployqt.Source)
            Write-Host "Found Qt via PATH: $qtDir"
          }
        }
        
        if ([string]::IsNullOrEmpty($qtDir) -or $qtDir -eq "null") {
          Write-Host "Error: Could not find Qt installation"
          Write-Host "Checking D:\a directory..."
          Get-ChildItem -Path "D:\a" -Recurse -Filter "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 3 | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }
          exit 1
        }
        
        Write-Host "Using Qt directory: $qtDir"
        echo "qt-dir=$qtDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: 使用 windeployqt 部署 Qt 依赖
      shell: powershell
      run: |
        $qtDir = "${{ steps.find-qt.outputs.qt-dir }}"
        $windeployqt = "$qtDir\bin\windeployqt.exe"
        Write-Host "Qt directory: $qtDir"
        Write-Host "windeployqt path: $windeployqt"
        
        if (Test-Path $windeployqt) {
          Write-Host "Deploying Qt dependencies..."
          
          # 部署基本 Qt 依赖
          & $windeployqt `
            --release `
            --qmldir "$PWD" `
            --no-opengl-sw `
            --no-system-d3d-compiler `
            --no-compiler-runtime `
            "release\otter-browser.exe"
          
          Write-Host "Checking for QtWebKit dependencies..."
          
          # 确保所有 QtWebKit DLL 文件都被复制
          $qtBinDir = "$qtDir\bin"
          $webKitDlls = Get-ChildItem -Path $qtBinDir -Filter "Qt5WebKit*.dll" -ErrorAction SilentlyContinue
          if ($webKitDlls) {
            Write-Host "Copying QtWebKit DLL files:"
            foreach ($dll in $webKitDlls) {
              Write-Host "  - $($dll.Name)"
              Copy-Item -Path $dll.FullName -Destination "release\" -Force
            }
          } else {
            Write-Host "Warning: No QtWebKit DLL files found in $qtBinDir"
          }
          
          # 复制 QtWebKit 插件
          $qtPluginsDir = "$qtDir\plugins"
          if (Test-Path "$qtPluginsDir\webkit") {
            Write-Host "Copying QtWebKit plugins..."
            New-Item -ItemType Directory -Force -Path "release\plugins\webkit" -ErrorAction SilentlyContinue
            Copy-Item -Path "$qtPluginsDir\webkit\*" -Destination "release\plugins\webkit\" -Recurse -Force
          }
          
          # 复制 QtWebKit 翻译文件
          $qtTranslationsDir = "$qtDir\translations"
          if (Test-Path "$qtTranslationsDir\qtwebkit_*.qm") {
            Write-Host "Copying QtWebKit translations..."
            New-Item -ItemType Directory -Force -Path "release\translations" -ErrorAction SilentlyContinue
            Copy-Item -Path "$qtTranslationsDir\qtwebkit_*.qm" -Destination "release\translations\" -Force
          }
          
          # 列出部署后的文件以验证
          Write-Host "`nDeployed files in release directory:"
          Get-ChildItem -Path "release" -File | Select-Object Name | ForEach-Object { Write-Host "  - $($_.Name)" }
          Write-Host "`nDeployed directories:"
          Get-ChildItem -Path "release" -Directory | Select-Object Name | ForEach-Object { Write-Host "  - $($_.Name)\" }
        } else {
          Write-Host "Error: windeployqt not found at $windeployqt"
          exit 1
        }
        
    - name: 复制翻译文件
      shell: powershell
      run: |
        if (Test-Path "resources\translations") {
          New-Item -ItemType Directory -Force -Path "release\locale" -ErrorAction SilentlyContinue
          Copy-Item -Path "resources\translations\*.qm" -Destination "release\locale\" -Force
        }
        
    - name: 读取版本号
      shell: powershell
      id: version
      run: |
        $content = Get-Content "CMakeLists.txt" -Raw
        if ($content -match 'set\(MAJOR_VERSION "(\d+)"\)') {
          $major = $matches[1]
        }
        if ($content -match 'set\(MINOR_VERSION "(\d+)"\)') {
          $minor = $matches[1]
        }
        if ($content -match 'set\(PATCH_VERSION "(\d+)"\)') {
          $patch = $matches[1]
        }
        $version = "$major.$minor.$patch"
        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "Version: $version"
        
    - name: 创建 ZIP 压缩包
      shell: powershell
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        $zipName = "otter-browser-win64-$env:VERSION.zip"
        Compress-Archive -Path "release\*" -DestinationPath $zipName -Force
        echo "Created: $zipName"
        
    - name: 上传 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: otter-browser-windows-${{ steps.version.outputs.version }}
        path: |
          otter-browser-win64-*.zip
        retention-days: 30

